#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# This file is part of macchiato
#   https://github.com/fernandezfran/macchiato/
# Copyright (c) 2023, Francisco Fernandez
# License: MIT
#   https://github.com/fernandezfran/macchiato/blob/master/LICENSE

# ============================================================================
# IMPORTS
# ============================================================================

import os
import pathlib

import numpy as np

import pandas as pd

import pytest

# =============================================================================
# FIXTURES
# =============================================================================


@pytest.fixture()
def data_path():
    return pathlib.Path(
        os.path.join(os.path.abspath(os.path.dirname(__file__)), "test_data")
    )


@pytest.fixture()
def Li12Si7(data_path):
    xyz_fname = str(data_path / "Li12Si7.xyz")
    boxes = [
        np.array([8.53123776, 19.62266159, 14.31268194, 90.0, 90.0, 90.0])
    ]

    df = pd.read_csv(data_path / "Li12Si7.csv", header=None)
    ppm = df.iloc[:, 0].to_numpy().reshape(-1, 1)
    intensity = (df.iloc[:, 1] - df.iloc[:, 1].min()).to_numpy()

    return {
        "xyz_fname": xyz_fname,
        "boxes": boxes,
        "bonded": 1.0,
        "isolated": 0.0,
        "contributions": np.full(96, 18.0),
        "ppm": ppm,
        "intensity": intensity,
        "sigma": 0.002342,
        "gamma": 6.719054,
        "heigth": 41.916436,
        "ypred": np.array(
            [
                0.08910164,
                0.09485228,
                0.10116759,
                0.1081224,
                0.11580406,
                0.12431498,
                0.1337757,
                0.14432878,
                0.15614363,
                0.1694225,
                0.18440805,
                0.20139287,
                0.22073153,
                0.24285573,
                0.26829354,
                0.2976935,
                0.33185462,
                0.37176312,
                0.41863578,
                0.47396807,
                0.53958054,
                0.61764795,
                0.71067736,
                0.82136842,
                0.95223424,
                1.1047865,
                1.27803382,
                1.46614514,
                1.65568759,
                1.82413247,
                1.94272054,
                1.98575223,
                1.94272054,
                1.82413247,
                1.65568759,
                1.46614514,
                1.27803382,
                1.1047865,
                0.95223424,
                0.82136842,
                0.71067736,
                0.61764795,
                0.53958054,
                0.47396807,
                0.41863578,
                0.37176312,
                0.33185462,
                0.2976935,
                0.26829354,
                0.24285573,
                0.22073153,
                0.20139287,
                0.18440805,
                0.1694225,
                0.15614363,
                0.14432878,
                0.1337757,
                0.12431498,
                0.11580406,
                0.1081224,
                0.10116759,
                0.09485228,
                0.08910164,
                0.08385128,
                0.07904561,
                0.07463644,
                0.07058186,
                0.06684527,
                0.06339463,
                0.0602018,
                0.05724196,
                0.0544932,
                0.05193609,
                0.04955336,
                0.04732965,
                0.04525122,
                0.04330577,
                0.04148228,
                0.03977084,
                0.03816249,
                0.03664919,
                0.03522363,
                0.03387919,
                0.03260986,
                0.03141019,
                0.03027519,
                0.02920033,
                0.02818144,
                0.02721472,
                0.02629669,
                0.02542415,
                0.02459415,
                0.02380398,
                0.02305115,
                0.02233334,
                0.02164842,
                0.02099443,
                0.02036953,
                0.01977203,
            ]
        ),
        "score": 0.993099,
    }


@pytest.fixture()
def Li13Si4(data_path):
    xyz_fname = str(data_path / "Li13Si4.xyz")
    boxes = [np.array([4.4207350, 7.8979870, 15.011548, 90.0, 90.0, 90.0])]
    df = pd.read_csv(data_path / "Li13Si4.csv", header=None)
    ppm = df.iloc[:, 0].to_numpy().reshape(-1, 1)
    intensity = (df.iloc[:, 1] - df.iloc[:, 1].min()).to_numpy()

    return {
        "xyz_fname": xyz_fname,
        "boxes": boxes,
        "bonded": 0.5,
        "isolated": 0.5,
        "contributions": np.array(
            [
                10.0,
                14.0,
                14.0,
                14.0,
                10.0,
                10.0,
                10.0,
                12.0,
                12.0,
                10.0,
                14.0,
                14.0,
                12.0,
                14.0,
                12.0,
                10.0,
                12.0,
                6.0,
                10.0,
                12.0,
                14.0,
                14.0,
                12.0,
                6.0,
                12.0,
                10.0,
            ]
        ),
        "ppm": ppm,
        "intensity": intensity,
        "sigma": 0.000733,
        "gamma": 10.901362,
        "heigth": 75.801919,
        "ypred": np.array(
            [
                0.17425487,
                0.18321685,
                0.19286654,
                0.2032735,
                0.21451588,
                0.22668169,
                0.23987018,
                0.25419349,
                0.26977853,
                0.28676917,
                0.3053287,
                0.32564268,
                0.34792215,
                0.37240719,
                0.39937092,
                0.42912368,
                0.46201747,
                0.49845018,
                0.53886926,
                0.58377398,
                0.6337151,
                0.68929013,
                0.75113132,
                0.8198826,
                0.89616016,
                0.98048999,
                1.07321482,
                1.17436372,
                1.28348146,
                1.39942462,
                1.52014835,
                1.64253173,
                1.76231361,
                1.87422037,
                1.97234422,
                2.0507668,
                2.10433411,
                2.1294141,
                2.12444877,
                2.09016059,
                2.02936849,
                1.94647755,
                1.8467897,
                1.73581074,
                1.61869261,
                1.49987366,
                1.38290838,
                1.27044063,
                1.16427026,
                1.06547317,
                0.97454502,
                0.89154695,
                0.81623774,
                0.74818389,
                0.68684474,
                0.631634,
                0.58196149,
                0.53725948,
                0.4969978,
                0.4606912,
                0.42790167,
                0.39823765,
                0.37135135,
                0.34693523,
                0.32471805,
                0.304461,
                0.28595393,
                0.26901189,
                0.25347203,
                0.23919083,
                0.22604166,
                0.21391258,
                0.20270454,
                0.1923297,
                0.18271006,
                0.1737762,
                0.16546623,
                0.15772487,
                0.15050267,
                0.14375527,
                0.13744285,
                0.13152958,
                0.12598314,
                0.12077438,
                0.11587691,
                0.11126682,
                0.10692242,
                0.102824,
                0.09895358,
                0.09529482,
                0.09183275,
                0.0885537,
                0.08544517,
                0.08249566,
                0.07969464,
                0.07703241,
                0.07450006,
                0.07208934,
                0.06979268,
            ]
        ),
        "score": 0.991874,
    }


@pytest.fixture()
def Li15Si4(data_path):
    xyz_fname = str(data_path / "Li15Si4.xyz")
    boxes = [np.array([10.566048, 10.566048, 10.566048, 90.0, 90.0, 90.0])]
    df = pd.read_csv(data_path / "Li15Si4.csv", header=None)
    ppm = df.iloc[:, 0].to_numpy().reshape(-1, 1)
    intensity = (df.iloc[:, 1] - df.iloc[:, 1].min()).to_numpy()

    return {
        "xyz_fname": xyz_fname,
        "boxes": boxes,
        "bonded": 0.0,
        "isolated": 1.0,
        "contributions": np.full(60, 6.0),
        "ppm": ppm,
        "intensity": intensity,
        "sigma": 3.387497,
        "gamma": 12.730414,
        "heigth": 88.938638,
        "ypred": np.array(
            [
                0.18200867,
                0.19015596,
                0.19884594,
                0.20812606,
                0.21804884,
                0.22867245,
                0.24006145,
                0.2522875,
                0.26543028,
                0.27957849,
                0.29483093,
                0.31129772,
                0.32910168,
                0.34837979,
                0.36928481,
                0.39198693,
                0.41667554,
                0.44356095,
                0.47287589,
                0.50487679,
                0.53984438,
                0.57808338,
                0.61992064,
                0.66570107,
                0.71578053,
                0.7705144,
                0.83024052,
                0.8952552,
                0.96578064,
                1.04192307,
                1.1236211,
                1.21058596,
                1.30223663,
                1.39763633,
                1.49543919,
                1.59385881,
                1.69067161,
                1.78326685,
                1.86875113,
                1.94410807,
                2.00640394,
                2.05301962,
                2.08188088,
                2.09165461,
                2.08188088,
                2.05301962,
                2.00640394,
                1.94410807,
                1.86875113,
                1.78326685,
                1.69067161,
                1.59385881,
                1.49543919,
                1.39763633,
                1.30223663,
                1.21058596,
                1.1236211,
                1.04192307,
                0.96578064,
                0.8952552,
                0.83024052,
                0.7705144,
                0.71578053,
                0.66570107,
                0.61992064,
                0.57808338,
                0.53984438,
                0.50487679,
                0.47287589,
                0.44356095,
                0.41667554,
                0.39198693,
                0.36928481,
                0.34837979,
                0.32910168,
                0.31129772,
                0.29483093,
                0.27957849,
                0.26543028,
                0.2522875,
                0.24006145,
                0.22867245,
                0.21804884,
                0.20812606,
                0.19884594,
                0.19015596,
                0.18200867,
                0.17436109,
                0.16717429,
                0.16041293,
                0.15404492,
                0.14804102,
                0.1423746,
                0.13702137,
                0.13195912,
                0.12716754,
                0.12262803,
                0.11832352,
                0.11423832,
            ]
        ),
        "score": 0.965234,
    }
